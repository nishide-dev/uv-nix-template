# Dockerç’°å¢ƒã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€é–‹ç™ºç”¨ã¨æœ¬ç•ªç”¨ã®2ç¨®é¡ã®Dockerç’°å¢ƒãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [å‰ææ¡ä»¶](#å‰ææ¡ä»¶)
- [é–‹ç™ºç’°å¢ƒï¼ˆDockerfile.devï¼‰](#é–‹ç™ºç’°å¢ƒdockerfiledev)
- [æœ¬ç•ªç’°å¢ƒï¼ˆDockerfile.prodï¼‰](#æœ¬ç•ªç’°å¢ƒdockerfileprod)
- [docker-composeã®ä½¿ã„æ–¹](#docker-composeã®ä½¿ã„æ–¹)
- [ã‚ˆãã‚ã‚‹è³ªå•](#ã‚ˆãã‚ã‚‹è³ªå•)

---

## æ¦‚è¦

### é–‹ç™ºç’°å¢ƒ vs æœ¬ç•ªç’°å¢ƒ

| é …ç›® | é–‹ç™ºç’°å¢ƒï¼ˆdevï¼‰ | æœ¬ç•ªç’°å¢ƒï¼ˆprodï¼‰ |
|------|----------------|-----------------|
| **ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸** | `ghcr.io/astral-sh/uv:python{{ python_version }}` | `ubuntu:22.04` |
| **ä¾å­˜é–¢ä¿‚** | å…¨ä¾å­˜é–¢ä¿‚ï¼ˆdevå«ã‚€ï¼‰ | æœ¬ç•ªä¾å­˜é–¢ä¿‚ã®ã¿ |
| **ãƒ“ãƒ«ãƒ‰æ–¹å¼** | ã‚·ãƒ³ã‚°ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ | ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆæœ€é©åŒ–ï¼‰ |
| **ã‚³ãƒ¼ãƒ‰ãƒã‚¦ãƒ³ãƒˆ** | âœ… ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œ | âŒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å›ºå®š |
| **SSHå¯¾å¿œ** | âœ… ãƒãƒ¼ãƒˆ2222 | âŒ |
| **ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º** | å¤§ãã„ | å°ã•ã„ |
| **ç”¨é€”** | ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚° | ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»CI/CD |

{% if use_nix %}
### Nixç’°å¢ƒã¨ã®ä½¿ã„åˆ†ã‘

- **Nix (æ¨å¥¨)**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã€å†ç¾æ€§é‡è¦–ã€è¤‡æ•°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†
- **Docker**: ãƒ‡ãƒ—ãƒ­ã‚¤ã€CI/CDã€Nixéå¯¾å¿œç’°å¢ƒã€ãƒãƒ¼ãƒ å…±æœ‰

**ãƒã‚¤ãƒ³ãƒˆ**: `uv.lock` ãŒä¸¡ç’°å¢ƒã®ä¾å­˜é–¢ä¿‚ã‚’ä¿è¨¼ã—ã¾ã™ã€‚
{% endif %}

---

## å‰ææ¡ä»¶

### å¿…é ˆãƒ„ãƒ¼ãƒ«

1. **Docker Desktop** ã¾ãŸã¯ **Docker Engine**
   ```bash
   # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
   docker --version
   docker compose version
   ```

2. **ãƒ›ã‚¹ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID/ã‚°ãƒ«ãƒ¼ãƒ—ID** (é–‹ç™ºç’°å¢ƒç”¨)
   ```bash
   # ç’°å¢ƒå¤‰æ•°ã«è¨­å®šï¼ˆæ¨å¥¨ï¼‰
   export USER_ID=$(id -u)
   export GROUP_ID=$(id -g)
   export USERNAME=$(whoami)
   ```

---

## é–‹ç™ºç’°å¢ƒï¼ˆDockerfile.devï¼‰

### ç‰¹å¾´

- âœ… **ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰**: ãƒ›ã‚¹ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚¦ãƒ³ãƒˆã€å¤‰æ›´ãŒå³åæ˜ 
- âœ… **SSHå¯¾å¿œ**: ãƒªãƒ¢ãƒ¼ãƒˆé–‹ç™ºç’°å¢ƒã¨ã—ã¦åˆ©ç”¨å¯èƒ½
- âœ… **å…¨é–‹ç™ºãƒ„ãƒ¼ãƒ«**: {% if use_ruff %}Ruffã€{% endif %}{% if use_ty %}tyã€{% endif %}{% if use_pytest %}Pytest{% endif %}ãªã©å…¨ã¦å«ã‚€
- âœ… **uvã‚­ãƒ£ãƒƒã‚·ãƒ¥æ°¸ç¶šåŒ–**: ä¾å­˜é–¢ä¿‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é«˜é€ŸåŒ–

### ãƒ“ãƒ«ãƒ‰

```bash
# Docker Composeã‚’ä½¿ã†å ´åˆï¼ˆæ¨å¥¨ï¼‰
docker compose build dev

# ç›´æ¥ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆ
docker build -f Dockerfile.dev -t {{ project_name }}-dev \
  --build-arg USERNAME=$(whoami) \
  --build-arg USER_ID=$(id -u) \
  --build-arg GROUP_ID=$(id -g) \
  .
```

### å®Ÿè¡Œ

```bash
# ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚·ã‚§ãƒ«
docker compose run --rm dev bash

# Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
docker compose run --rm dev python -m {{ package_name }}.main

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
{% if use_pytest %}
docker compose run --rm dev pytest
{% else %}
docker compose run --rm dev python -m unittest
{% endif %}

# Linter/Formatterå®Ÿè¡Œ
{% if use_ruff %}
docker compose run --rm dev ruff check .
docker compose run --rm dev ruff format .
{% endif %}

# ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
docker compose up -d dev
docker compose logs -f dev
```

### SSHçµŒç”±ã§ã®ã‚¢ã‚¯ã‚»ã‚¹

```bash
# ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•
docker compose up -d dev

# ã‚³ãƒ³ãƒ†ãƒŠå†…ã§SSHãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’èµ·å‹•
docker compose exec dev sudo /usr/sbin/sshd

# SSHå…¬é–‹éµã‚’é…ç½®
docker compose exec -u $(whoami) dev mkdir -p ~/.ssh
docker compose cp ~/.ssh/id_rsa.pub $(docker compose ps -q dev):/home/$(whoami)/.ssh/authorized_keys
docker compose exec -u $(whoami) dev chmod 600 ~/.ssh/authorized_keys

# SSHã§ã‚¢ã‚¯ã‚»ã‚¹
ssh -p 2222 $(whoami)@localhost
```

---

## æœ¬ç•ªç’°å¢ƒï¼ˆDockerfile.prodï¼‰

### ç‰¹å¾´

- âš¡ **æœ€å°ã‚¤ãƒ¡ãƒ¼ã‚¸**: ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§æœ€é©åŒ–
- ğŸ”’ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã€read-only filesystem
- ğŸ“¦ **è‡ªå·±å®Œçµ**: ä¾å­˜é–¢ä¿‚ã¨ã‚³ãƒ¼ãƒ‰ã‚’å…¨ã¦å«ã‚€
- â™»ï¸ **è‡ªå‹•å†èµ·å‹•**: `restart: unless-stopped` è¨­å®šæ¸ˆã¿

### ãƒ“ãƒ«ãƒ‰

```bash
# Docker Composeã‚’ä½¿ã†å ´åˆï¼ˆæ¨å¥¨ï¼‰
docker compose build prod

# ç›´æ¥ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆ
docker build -f Dockerfile.prod -t {{ project_name }}-prod \
  --build-arg USERNAME=appuser \
  .
```

### å®Ÿè¡Œ

```bash
# ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
docker compose up prod

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
docker compose up -d prod

# ãƒ­ã‚°ç¢ºèª
docker compose logs -f prod

# åœæ­¢
docker compose down
```

### ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚³ãƒãƒ³ãƒ‰ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œ
docker run --rm {{ project_name }}-prod python -c "import {{ package_name }}; print('OK')"

# ç’°å¢ƒå¤‰æ•°ã‚’æ¸¡ã™
docker run --rm -e MY_VAR=value {{ project_name }}-prod python -m {{ package_name }}.main

# ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°
docker run --rm -p 8080:8000 {{ project_name }}-prod python -m {{ package_name }}.server
```

---

## docker-composeã®ä½¿ã„æ–¹

### åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§
docker compose ps

# ãƒ“ãƒ«ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
docker compose build --no-cache dev

# ãƒ­ã‚°ç¢ºèª
docker compose logs -f dev

# ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹
docker compose exec dev bash

# åœæ­¢ã—ã¦å‰Šé™¤
docker compose down

# ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤
docker compose down -v
```

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š

```bash
# .env
USERNAME=myuser
USER_ID=1000
GROUP_ID=1000
```

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

`docker-compose.override.yml` ã‚’ä½œæˆã—ã¦è¨­å®šã‚’ä¸Šæ›¸ãï¼š

```yaml
# docker-compose.override.yml
services:
  dev:
    ports:
      - "8080:8000"  # ãƒãƒ¼ãƒˆå¤‰æ›´
    environment:
      - DEBUG=true
    volumes:
      - ./custom:/app/custom  # è¿½åŠ ãƒã‚¦ãƒ³ãƒˆ
```

---

## ã‚ˆãã‚ã‚‹è³ªå•

### Q1: Nixç’°å¢ƒã¨Dockerç’°å¢ƒã§ä¾å­˜é–¢ä¿‚ãŒç•°ãªã‚‹ã“ã¨ã¯ã‚ã‚‹ï¼Ÿ

A: **ã‚ã‚Šã¾ã›ã‚“**ã€‚`uv.lock` ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸¡ç’°å¢ƒã§å…±æœ‰ã•ã‚Œã‚‹ãŸã‚ã€å…¨ãåŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä¾å­˜é–¢ä¿‚ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚

### Q2: é–‹ç™ºç’°å¢ƒã§ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œãªã„

A: ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š
1. `docker-compose.yml` ã§ `.:/app` ãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹
2. ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ï¼ˆ`docker compose ps`ï¼‰
3. ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œã®ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‹ï¼ˆuvicorn --reload ãªã©ï¼‰

### Q3: "permission denied" ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹

A: ãƒ›ã‚¹ãƒˆã¨ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“ï¼š

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export USER_ID=$(id -u)
export GROUP_ID=$(id -g)
export USERNAME=$(whoami)

# å†ãƒ“ãƒ«ãƒ‰
docker compose build --no-cache dev
```

### Q4: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’å°ã•ãã—ãŸã„

A: æœ¬ç•ªç’°å¢ƒï¼ˆDockerfile.prodï¼‰ã¯æ—¢ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã•ã‚‰ã«å‰Šæ¸›ã™ã‚‹å ´åˆï¼š
- ä¸è¦ãªä¾å­˜é–¢ä¿‚ã‚’ `pyproject.toml` ã‹ã‚‰å‰Šé™¤
- `.dockerignore` ã‚’è¦‹ç›´ã—ã¦ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
- Alpine Linuxãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ï¼ˆãŸã ã—ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒå¢—ãˆã‚‹å¯èƒ½æ€§ã‚ã‚Šï¼‰

### Q5: Dockerãƒ“ãƒ«ãƒ‰ãŒé…ã„

A: ä»¥ä¸‹ã‚’è©¦ã—ã¦ãã ã•ã„ï¼š
1. **uvã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨**: `--mount=type=cache,target=/root/.cache/uv` ã¯æ—¢ã«è¨­å®šæ¸ˆã¿
2. **BuildKitã‚’æœ‰åŠ¹åŒ–**: `export DOCKER_BUILDKIT=1`
3. **ä¾å­˜é–¢ä¿‚ã‚’å›ºå®š**: `uv.lock` ã‚’æœ€æ–°ã«ä¿ã¤

### Q6: æœ¬ç•ªç’°å¢ƒã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’æ‰±ã†ã«ã¯ï¼Ÿ

A: ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯Docker Secretsã‚’ä½¿ç”¨ï¼š

```bash
# ç’°å¢ƒå¤‰æ•°
docker run --rm -e DATABASE_URL=postgresql://... {{ project_name }}-prod

# Docker Secretsï¼ˆSwarm/Kubernetesï¼‰
docker secret create db_password /path/to/secret
docker service create --secret db_password {{ project_name }}-prod
```

### Q7: CI/CDã§Dockerã‚’ä½¿ã„ãŸã„

A: GitHub Actionsã®ä¾‹ï¼š

```yaml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build and test
        run: |
          docker compose build prod
          docker compose run --rm prod pytest
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Dockerå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.com/)
- [Docker Composeå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.com/compose/)
- [uv Dockerçµ±åˆã‚¬ã‚¤ãƒ‰](https://docs.astral.sh/uv/guides/integration/docker/)
- [uv-docker-example](https://github.com/astral-sh/uv-docker-example)
{% if use_nix %}
- [Nixç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](NIX_SETUP.md)
{% endif %}
